<Page
    x:Name="InventoryPageRoot"
    x:Class="CoffeePOS.Views.InventoryPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:controls="using:CommunityToolkit.WinUI.UI.Controls"
    mc:Ignorable="d">

    <Grid x:Name="ContentArea" Padding="20">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="Auto" />
            <ColumnDefinition Width="*" />
        </Grid.ColumnDefinitions>

        <Grid Grid.Column="0">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <!-- Header with search and add button -->
            <Grid Grid.Row="0" Margin="0,0,0,10">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <AutoSuggestBox 
                    Grid.Column="0"
                    PlaceholderText="Search ingredients..."
                    QueryIcon="Find"
                    Text="{x:Bind ViewModel.SearchQuery, Mode=TwoWay}"
                    TextChanged="AutoSuggestBox_TextChanged"
                    QuerySubmitted="AutoSuggestBox_QuerySubmitted"
                    Style="{StaticResource AutoSuggestBoxStyle}" />

                <Button 
                    Grid.Column="1"
                    Margin="10,0,0,0"
                    Style="{StaticResource AccentButtonStyle}"
                    Click="AddIngredient_Click">
                    <StackPanel Orientation="Horizontal" Spacing="5">
                        <FontIcon Glyph="&#xE710;" FontSize="16" />
                        <TextBlock Text="Add Ingredient" />
                    </StackPanel>
                </Button>
            </Grid>

            <!-- Ingredients DataGrid -->
            <controls:DataGrid
                Grid.Row="1"
                AutoGenerateColumns="False"
                GridLinesVisibility="Horizontal"
                AlternatingRowBackground="{ThemeResource SystemControlAltHighAcrylicElementBrush}"
                CanUserSortColumns="True"
                SelectedItem="{x:Bind ViewModel.SelectedIngredient, Mode=TwoWay}"
                SelectionChanged="OnIngredientSelectionChanged"
                ItemsSource="{x:Bind ViewModel.Ingredients, Mode=OneWay}">
                <controls:DataGrid.Columns>
                    <controls:DataGridTextColumn Header="ID" Binding="{Binding Id}" Width="50" />
                    <controls:DataGridTextColumn Header="Name" Binding="{Binding Name}" Width="*" />
                    <controls:DataGridTextColumn Header="Quantity" Binding="{Binding Quantity}" Width="100" />
                    <controls:DataGridTextColumn Header="Unit" Binding="{Binding Unit}" Width="80" />
                    <controls:DataGridTemplateColumn Header="Status" Width="120">
                        <controls:DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Grid>
                                    <TextBlock 
                                        Text="Low Stock" 
                                        Foreground="Red" 
                                        Visibility="{Binding Quantity, Converter={StaticResource LowStockVisibilityConverter}, ConverterParameter={Binding Threshold}}" />
                                    <TextBlock 
                                        Text="In Stock" 
                                        Foreground="Green" 
                                        Visibility="{Binding Quantity, Converter={StaticResource NormalStockVisibilityConverter}, ConverterParameter={Binding Threshold}}" />
                                </Grid>
                            </DataTemplate>
                        </controls:DataGridTemplateColumn.CellTemplate>
                    </controls:DataGridTemplateColumn>
                    <controls:DataGridTemplateColumn Header="Actions" Width="120">
                        <controls:DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal" Spacing="5">
                                    <Button 
                                        Tag="{Binding}"
                                        ToolTipService.ToolTip="Add Transaction"
                                        Click="AddTransaction_Click">
                                        <FontIcon Glyph="&#xE73E;" FontSize="16" />
                                    </Button>
                                    <Button 
                                        Tag="{Binding}"
                                        ToolTipService.ToolTip="Edit"
                                        Click="EditIngredient_Click">
                                        <FontIcon Glyph="&#xE70F;" FontSize="16" />
                                    </Button>
                                    <Button 
                                        Tag="{Binding}"
                                        ToolTipService.ToolTip="Delete"
                                        Click="DeleteIngredient_Click">
                                        <FontIcon Glyph="&#xE74D;" FontSize="16" Foreground="Red" />
                                    </Button>
                                </StackPanel>
                            </DataTemplate>
                        </controls:DataGridTemplateColumn.CellTemplate>
                    </controls:DataGridTemplateColumn>
                </controls:DataGrid.Columns>
            </controls:DataGrid>
        </Grid>

        <!-- Separator -->
        <Rectangle 
            Grid.Column="1" 
            Width="1" 
            Margin="20,0" 
            Fill="{ThemeResource SystemControlForegroundBaseLowBrush}" />

        <!-- Transactions Panel -->
        <Grid Grid.Column="2" Visibility="{x:Bind ViewModel.SelectedIngredient, Mode=OneWay, Converter={StaticResource ObjectToVisibilityConverter}}">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <!-- Transaction Header -->
            <StackPanel Grid.Row="0" Margin="0,0,0,15">
                <TextBlock Text="Transaction History" Style="{StaticResource SubtitleTextBlockStyle}" />
                <TextBlock Text="{x:Bind ViewModel.SelectedIngredient.Name, Mode=OneWay}" Style="{StaticResource TitleTextBlockStyle}" />
                <StackPanel Orientation="Horizontal" Spacing="5" Margin="0,5,0,0">
                    <TextBlock Text="Current Stock:" />
                    <TextBlock Text="{x:Bind ViewModel.SelectedIngredient.Quantity, Mode=OneWay}" FontWeight="SemiBold" />
                    <TextBlock Text="{x:Bind ViewModel.SelectedIngredient.Unit, Mode=OneWay}" />
                </StackPanel>
            </StackPanel>

            <!-- Transactions DataGrid -->
            <controls:DataGrid
                Grid.Row="1"
                AutoGenerateColumns="False"
                GridLinesVisibility="Horizontal"
                AlternatingRowBackground="{ThemeResource SystemControlAltHighAcrylicElementBrush}"
                CanUserSortColumns="True"
                ItemsSource="{x:Bind ViewModel.Transactions, Mode=OneWay}">
                <controls:DataGrid.Columns>
                    <controls:DataGridTextColumn Header="ID" Binding="{Binding Id}" Width="50" />
                    <controls:DataGridTemplateColumn Header="Date" Width="150">
                        <controls:DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding Timestamp, Converter={StaticResource UnixTimestampConverter}}" />
                            </DataTemplate>
                        </controls:DataGridTemplateColumn.CellTemplate>
                    </controls:DataGridTemplateColumn>
                    <controls:DataGridTemplateColumn Header="Type" Width="100">
                        <controls:DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock 
                                    Text="{Binding TransactionType}" 
                                    Foreground="{Binding TransactionType, Converter={StaticResource TransactionTypeColorConverter}}" />
                            </DataTemplate>
                        </controls:DataGridTemplateColumn.CellTemplate>
                    </controls:DataGridTemplateColumn>
                    <controls:DataGridTextColumn Header="Quantity" Binding="{Binding Quantity}" Width="80" />
                    <controls:DataGridTextColumn Header="Unit" Binding="{Binding Unit}" Width="80" />
                    <controls:DataGridTemplateColumn Header="Unit Price" Width="100">
                        <controls:DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding UnitPrice, Converter={StaticResource CurrencyConverter}}" />
                            </DataTemplate>
                        </controls:DataGridTemplateColumn.CellTemplate>
                    </controls:DataGridTemplateColumn>
                    <controls:DataGridTemplateColumn Header="Total" Width="100">
                        <controls:DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding Converter={StaticResource TransactionTotalConverter}}" />
                            </DataTemplate>
                        </controls:DataGridTemplateColumn.CellTemplate>
                    </controls:DataGridTemplateColumn>
                </controls:DataGrid.Columns>
            </controls:DataGrid>

            <!-- Empty state message -->
            <TextBlock 
                Grid.Row="1"
                HorizontalAlignment="Center"
                VerticalAlignment="Center"
                Text="No transactions found for this ingredient"
                Visibility="{x:Bind ViewModel.Transactions.Count, Mode=OneWay, Converter={StaticResource EmptyCollectionVisibilityConverter}}" />
        </Grid>

        <!-- Empty state for transactions panel -->
        <TextBlock 
            Grid.Column="2"
            HorizontalAlignment="Center"
            VerticalAlignment="Center"
            Text="Select an ingredient to view transaction history"
            FontStyle="Italic"
            Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"
            Visibility="{x:Bind ViewModel.SelectedIngredient, Mode=OneWay, Converter={StaticResource ObjectToVisibilityConverterInverted}}" />
    </Grid>
</Page>